```{r,echo=FALSE,message=FALSE,warning=FALSE}
library(lidR)
library(ggplot2)
library(raster)
library(stars)
library(forcats)
library(sf)

r3dDefaults = rgl::r3dDefaults
m = structure(c(0.921, -0.146, 0.362, 0, 0.386, 0.482, -0.787, 0, 
-0.06, 0.864, 0.5, 0, 0, 0, 0, 1), .Dim = c(4L, 4L))
r3dDefaults$FOV = 50
r3dDefaults$userMatrix = m
r3dDefaults$zoom = 0.75

knitr::opts_chunk$set(
  comment =  "#>", 
  collapse = TRUE,
  fig.align = "center")

rgl::setupKnitr(autoprint = TRUE)

las <- readLAS("data/05_data_load/1kmZ176280518102020L.laz", select = "xyzc")
ctg <- readLAScatalog("data/05_data_load/ctg_example", filter = "-drop_withheld -keep_random_fraction 0.25")
dtm <- raster("data/05_data_load/DTM.tif")
dtm_small <- raster("data/05_data_load/DTM_small.tif")
roads <- st_read("data/05_data_load/roads_las.shp")
```

# Reading, Generating, and Plotting Input Data {#sec-reading-generating-and-plotting-input-data}

## Reading LiDAR data {#sec-reading-lidar-data}

The `lidR` function `readLAS()` reads a LAS or LAZ file and returns an object of class `LAS`. Detailed information on loading LiDAR data using the `lidR` package can be found in the [dedicated lidR vignette](https://cran.r-project.org/web/packages/lidR/vignettes/lidR-LAS-class.html). In this user guide, we do not delve deeply into methods for working with ALS data and instead refer interested users to the [lidR book](https://r-lidar.github.io/lidRbook/io.html#read).

For road extraction using the `ALSroads` method, users are only required to load LAS data.

### Reading LiDAR data using `readLAS` {#sec-reading-lidar-data-using-readlas}

The function `readLAS()` reads and creates a LAS object.

```r
las <- readLAS("path/to/ALS_Example.las")
```

When printed, we display a summary of the LAS tile content.

```{r}
print(las)
```

#### Plotting LiDAR Data {#sec-plotting-lidar-data}

For users interested in visualizing LiDAR data prior to road extraction, the `lidR` package uses the [`rgl`](https://cran.r-project.org/package=rgl) package to provide a interactive 3D viewer.

#### Basic 3D rendering {#sec-basic-3d-rendering}

A basic way to render a point cloud and plot a LAZ or LAS tile is the function `plot()`.

``` r
plot(las)
```

```{r, echo = FALSE, rgl = TRUE, fig.width = 4, fig.height = 3}
las_circle_25 <- clip_circle(las, 628300, 5181400 , 25)
plot(las_circle_25, bg = "white", size = 3)
```

Detailed information on how users can change the attributes used for coloring the points is provided in the [lidR book](https://r-lidar.github.io/lidRbook/io.html#asprs-compliance).

#### Overlay Plotting {#sec-overlay-plotting}

The `ALSroads` method for road extraction relies on a DTM as a primary component for road extraction. We include information on overlaying LAZ data with a DTM. The `lidR` package provides easy to use functions for common overlay, including `add_dtm3d()` which overlays a DTM and a LAS tile (see section \@ref(dtmdata) for information on DTMs).

```{r, echo = FALSE, warning=FALSE}
las_circle_200 <- clip_circle(las, 628300, 5181400 , 200)
```

```{r plot-las-dtm, rgl = TRUE, fig.width = 4, fig.height = 3}
x <- plot(las_circle_200, bg = "white", size = 3)
add_dtm3d(x, dtm_small)
```

## Reading LiDAR data using `readLAScatalog` {#sec-reading-lidar-data-using-readlascatalog}

A `LAScatalog` is a representation in R of a LAS file or a collection of LAS files not loaded in memory. A regular computer cannot load the entire point cloud in R if it covers a broad area. In `lidR`, the function `readLAScatalog()` creates an object that represents, in R, a collection of LAS files not loaded in memory.

``` r
ctg <- readLAScatalog("path/to/ctg/files")
```

When printed, `las_ctg` displays a summary of its content (in this example, the LAS catalog contains only 10 LAS tiles.)

```{r}
print(ctg)
```

#### Plotting LAScatalog object {#sec-plotting-lascatalog-object}

`lidR` provides a simple plot() function to plot a `LAScatalog` object:

```{r, echo = FALSE, rgl = TRUE, fig.width = 4, fig.height = 3}
plot(ctg)
```

## Reading and Generating DTM Raster Data {#sec-reading-and-generating-dtm-raster-data}

### Reading raster DTM data using `raster` {#sec-reading-raster-dtm-data-using-raster}

`ALSroads` users may be provided a 1 m resolution DTM that covers the `LAScatalog` coverage. If DTM data is provided, then users can load this information using the `raster` package.

``` r
dtm <- raster("path/to/dtm.tif)
```

#### Plotting DTM Data {#sec-plotting-dtm-data}

The loaded DTM can be plotted for user visualization using the `plot_dtm3d()` function from the `lidR` package.

``` r
plot_dtm3d(dtm)
```

```{r plot-dtm, echo = FALSE, rgl = TRUE, fig.width = 4, fig.height = 3}
plot_dtm3d(dtm, bg = "white") 
```

### Generating DTM data using `rasterize_terrain()` {#sec-generating-dtm-data-using-grid_terrain}

`ALSroads` users that do not have an existing 1 m resolution DTM can produce a DTM using LAS data and the function `grid_terrain()` from the `lidR` packages.

The `rasterize`_terrain()` function interpolates ground points and creates a rasterized DTM. The interpolation can be done using 3 methods: "knnidw", "delaunay", or "kriging" (for detailed information on each method, refer to the [lidR book](https://r-lidar.github.io/lidRbook/io.html#asprs-compliance)).

Here we demonstrate the Triangular irregular network (tin) interpolation method. This method is based on a TIN of ground point data to derive a bivariate function for each triangle, which is then used to estimate the values at unsampled locations. The TIN method is fast, efficient, and generates good DTMs.

```{r triangulation, echo = FALSE, snapshot = TRUE}
las2 <- filter_ground(las)
dxyz <- with(las2@data, deldir::deldir(X, Y, z = Z, suppressMsge = TRUE))
col <- with(las2@data, height.colors(20)[1 + round(19*(Z - min(Z))/diff(range(Z)))])
rgl::persp3d(dxyz, col = col, smooth = FALSE, add = T, front="lines", axes = F)
rgl::axes3d(c("x-", "y+", "z-"))
rgl::grid3d(side=c('x-', 'y+', 'z-'), col="gray")
```

To generate a DTM model with the TIN algorithm we the `rasterize_terrain()` function and specify the algorithm using `algorithm = tin()`.

``` r
dtm_tin <- rasterize_terrain(ctg, res = 1, algorithm = tin())
```

## Reading Vector Road Data using `st_read()` {#sec-reading-vector-road-data-using-st_read(}

An existing road network is required to perform road extraction using `ALSroads`. Once users have sourced road data (file format = shapefile), the entire road network can be loaded into R using the `sf` package. The function `st_read()` reads simple features from file. Detailed information on the `st_read()` function and the `sf` package is available online in a [dedicated vignette](https://r-spatial.github.io/sf/articles/).

``` r
roads <- st_read("path/to/roads")
```
