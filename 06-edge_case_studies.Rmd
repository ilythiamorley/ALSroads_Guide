```{r,echo=FALSE,message=FALSE,warning=FALSE}
library(lidR)
library(ggplot2)
library(raster)
library(sf)

r3dDefaults = rgl::r3dDefaults
m = structure(c(0.921, -0.146, 0.362, 0, 0.386, 0.482, -0.787, 0, 
-0.06, 0.864, 0.5, 0, 0, 0, 0, 1), .Dim = c(4L, 4L))
r3dDefaults$FOV = 50
r3dDefaults$userMatrix = m
r3dDefaults$zoom = 0.75

knitr::opts_chunk$set(
  comment =  "#>", 
  collapse = TRUE,
  fig.align = "center")

rgl::setupKnitr(autoprint = TRUE)
knitr::opts_chunk$set(echo = TRUE)
#Case study: DTM compx

las_infolder <- ("data/06/01/ctg/")
ctg_cs1 <- readLAScatalog(las_infolder, filter = "-drop_withheld -keep_random_fraction 0.25")
dtm_cs1 <- raster("data/06/01/DTM.tif")
dtm20 <- raster("data/06/01/DTM20.tif")
rds_cs1 <- st_read("data/06/01/roads.shp")
upd_rds_cs1 <- st_read("data/06/01/upd_roads.shp") # Standard Parameters
```

# Edge Case Studies {#sec-edge-case-studies}

In this section, we present three known edge case studies where the `measure_road()` standard parameters (see section \@ref(sec-explanation-of-parameters-measure_roads) may require tuning:

-   **Case Study 1: Low DTM complexity**

-   **Case Study 2: Narrow/Wide Roads**

-   **Case Study 3: max_percentage_drivable**

-   **Case Study 4: Road State Classifications**

    -   drivable_width_thresholds

    -   percentage_veg_thresholds

    -   shoulder_thresholds

-   **Case Study 5: No vegetation** - an area where the road is not clearly defined by vegetation, there are three known no vegetation scenarios:

    1.  The roads are nicely shaped, is not an edge case, and the algorithm should be able to accurate update the road.
    2.  The DTM is very flat and locating the road is a challenge.
    3.  It so hard to find the road that even the least cost path fails because the roads are not highlighted enough compared to the surrounding vegetation, refer to [Roussel et al. (2022)](https://www.sciencedirect.com/science/article/pii/S1569843222002084#d1e1483) on how the least cost algorithm works to identify roads. In this case we are facing a hard limit.

## Case Study Structure:

For each case study, we include code snippets outlining how to:

1.  Read the required input data (refer to section \@ref(sec-reading-generating-and-plotting-input-data) for detailed information).
2.  Check the Coordinate Reference System (CRS) of input data and clip the existing road network to the spatial extent of the LAS catalog.
3.  Update the existing road network using the `measure_roads()` function from the `ALSroads` package.
4.  Adjust the standard road extraction parameters to improve method accuracy. Information on the `measure_roads()` standard parameters is available in Section \@ref(sec-explanation-of-parameters-measure_roads).
5.  Visualize road extraction results.

Each case study is 'stand-alone' and users do not need to refer to other sections of the user guide. As such, some code snippets, such as loading data, are repeated for each case study.

## Case Study 1: Low DTM complexity {#sec-case-study-low-dtm-complexity}

### Overview: {#sec-overview}

Among other factors, such as vegetation and slope, the road extraction method developed by [Roussel et al. (2022)](%5Bhttps://www.sciencedirect.com/science/article/pii/S1569843222002084#d1e1483) uses the complexity of the input DTM to correctly position the updated road. The road extraction method works by applying a Sobel filter [(Sobel. 2014)](https://www.researchgate.net/publication/239398674_An_Isotropic_3x3_Image_Gradient_Operator) on the DTM to detect sharp road edges. Under ideal circumstances, the Slope complex enough that the algorithm can distinguish between the drivable and total road edge and determine the road width (see section \@ref(sec-embankments-parameters)).

In the absence of embankments the `measure_roads` function uses the DTM complexity to detect road edges (see section \@ref(sec-terrain-parameters)). In the event that users are updating roads in very flat areas where there is little DTM complexity the standard parameters can be tuned to improve method accuracy.

In this case study we demonstrate how users can tune `measure_roads` parameters in low DTM complexity conditions. The example case study roads are located in the eastern portion of the Nipissing Forest, located in the province of Ontario.

![](images/06_01_dtm.PNG)

### Data, Method, and Application: {#sec-method-and-application}

### Required R Packages: {#sec-required-r-packages}

``` r
remotes::install_github("Jean-Romain/ALSroads") #Install the ALSroads Package

library("ALSroads") 
library("lidR")
library("raster")
library("sf")
library("ggplot2")
```

#### Loading Data: {#sec-loading-data}

``` r
ctg <- readLAScatalog"path/to/ctg/files", filter = "-drop_withheld-keep_random_fraction 0.25")
dtm <- raster("path/to/dtm.tif")
roads <- st_read("path/to/roads")

st_crs(roads) = st_crs(ctg)
roads = sf::st_crop(roads, ctg)
```

#### Parameter Tuning {#sec-parameter-tuning}

The `measure_roads()` **terrain parameters** dictate how the method handles DTM complexity (see section \@ref(sec-terrain-parameters)). The standard terrain parameters are:

1.  max_elevation_ground_points: `Default = 0.1`
2.  max_sd_ground_points: `Default = 0.15`

In a low DTM complexity area decreasing the `max_elevation_ground_points` and `max_sd_ground_points` improves the accuracy of road extraction. **In this case study we decrees the `max_elevation_ground_points` to 0.07 and decrees the `max_sd_ground_points` to 0.04.**

``` r
custom_param = alsroads_default_parameters
custom_param$terrain$max_elevation_ground_points = 0.07
custom_param$terrain$max_sd_ground_points = 0.04

updated_roads_custom_param <- measure_roads(ctg = ctg, roads = roads, dtm = dtm, param = custom_param)
```

### Results: {#sec-results}

Plotting the updated road network alongside the existing road network allows the visualization of the updated roads.

```{r, echo = FALSE, fig.width = 7.1, fig.height = 7}
poly = mapply(function(x,y)
{
  x = st_geometry(x)
  if (!is.na(y)) 
    x = st_buffer(x, dist = y) 
  else 
    x = st_buffer(x, dist = 0.1)
  return(st_sf(st_sfc(x)))
}, 
st_geometry(upd_rds_cs1), 
upd_rds_cs1$ROADWID)
poly = do.call(c, poly)
st_crs(poly) = st_crs(upd_rds_cs1)

plot(dtm_cs1, col = gray((0:25)/25))
plot(st_geometry(rds_cs1), add = T)
col = c("lightgray", "darkgreen", "orange", "red", "black")[upd_rds_cs1$CLASS+1]
plot(poly, add = T, col = col, border = col, lwd = 2)
```

## Case Study 2: Narrow/Wide Roads {#sec-case-study-steep-slopes}

### Overview:

The road extraction method developed by [Roussel et al. (2022)](%5Bhttps://www.sciencedirect.com/science/article/pii/S1569843222002084#d1e1483) updated an existing road network by searching within a buffer area of the existing road for an updated road line. The algorithm processes only the point cloud within the buffer around the reference roads (see section \@ref(sec-extraction-parameters)). This value corresponds to the biggest road offset error (i.e., how incorrect the existing road track is) that can be fixed by the method.

In some circumstances users may know that the updated is beyond the standard road buffer distance (80 m) and tune the `road_buffer` parameter accordingly. Similar, if a user knows that the maximum road track error is less than the standard buffer the`road_buffer`can be reduced to increase accuracy and reduce computation.

In this case study we demonstrate how users can tune `measure_roads` parameters in an area where the updated road is very close to the existing road. The example case study roads are located in the eastern portion of the Nipissing Forest, located in the province of Ontario.

### Data, Method, and Application:

#### Required R Packages:

``` r
remotes::install_github("Jean-Romain/ALSroads") #Install the ALSroads Package

library("ALSroads") 
library("lidR")
library("raster")
library("sf")
library("ggplot2")
```

#### Loading Data:

``` r
ctg <- readLAScatalog"path/to/ctg/files", filter = "-drop_withheld-keep_random_fraction 0.25")
dtm <- raster("path/to/dtm.tif")
roads <- st_read("path/to/roads")

st_crs(roads) = st_crs(ctg)
roads = sf::st_crop(roads, ctg)
```

#### Parameter Tuning:

The `measure_roads()` **extraction parameters** include a parameter called `road_buffer` for defining the road buffer width (see section \@ref(sec-extraction-parameters)). The default `road_buffer` distance is 80 m, but in this case study we know that the updated road is \< 10 m from the existing road network. **In this case study we decrees the `road_buffer` to 40 m**

``` r
custom_param = alsroads_default_parameters
custom_param$extraction$road_buffer = 40

updated_roads_custom_param <- measure_roads(ctg = ctg, roads = roads, dtm = dtm, param = custom_param)
```

### Results:

Plotting the updated road network alongside the existing road network allows the visualization of the updated roads.

## Case Study 2: Narrow/Wide Roads

## Case Study 2: Narrow/Wide Roads

## Case Study 2: Narrow/Wide Roads

## Case Study: No Vegetation {#sec-case-study-no-veg}

### Scenario Three: It so hard to find the road that even the least cost path fails because the roads are not highlighted enough compared to the surrounding vegetation. In that case we are facing a hard limit.
